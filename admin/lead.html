<?php
session_start();

// Check if session exists
if (!isset($_SESSION['username'])) {
    header("Location: ../pages/login.php");
    exit;
}

// Set session validation token
if (!isset($_SESSION['page_token'])) {
    $_SESSION['page_token'] = md5(uniqid(rand(), true));
}
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Real Estate Dashboard - Properties</title>

    <!-- âœ… Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">


    <!-- ck-editors  -->
    <!-- <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script> -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>



    <!-- css style -->
    <link rel="stylesheet" href="./style.css">

    <!-- toster links   -->

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>



</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div>
            <h4>Real Estate</h4>
            <a href="./index.php"><img src="./images/Vector1.png" alt="1">Users</a>
            <a href="./property.php"><img src="./images/Vector2.png" alt="2">Add Properties</a>
            <a href="./lead.html" class="active"><i class="fa-solid fa-circle-user"
                    style="padding-right:20px;"></i>Leads</a>
        </div>
        <div>
            <div>
                <a href="../real-estate-landing-page/index.html" class="landing-page">Landing Page</a>
            </div>
            <div class="mb-4 logout">
                <a href="../pages/logout.php" class="btn btn-danger">Logout</a>
            </div>
        </div>
    </div>

    <div class="main-contents">
        <!-- Top Navbar -->
        <div class="topbar">
            <h5 class="m-0" style="color:#2F3A4A;">Property Dashboard</h5>
        </div>

    </div>

    <!-- Main Content -->

    <div class="main-content">
        <div class="jumbotron jumbotron-fluid mb-5 d-flex justify-content-between align-items-center">
            <div class="container">
                <h1 class="display-4">All Leads</h1>
                <p class="lead">Browse and manage your Clients</p>
            </div>

        </div>

        <div id="propertyContainer" class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadList">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading inquiries...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>



    <!-- <script src="./script.js"></script> -->
    <script>
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            return text
                ? text.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                : "";
        }

        // Fetch inquiries from API and display
        async function displayInquiries() {
            const tbody = document.getElementById("leadList");
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>';

            try {
                const response = await fetch("http://localhost/real_estate_dashboard/admin/get-contacts.php");
                const result = await response.json();

                if (result.status !== "success" || !result.data.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No inquiries found.</td></tr>';
                    return;
                }

                tbody.innerHTML = "";

                result.data.forEach((inq, index) => {
                    const row = `
        <tr>
          <td>${escapeHtml(inq.id)}</td>
          <td>${escapeHtml(inq.fullname)}</td>
          <td>${escapeHtml(inq.email)}</td>
          <td>${escapeHtml(inq.phonenumber)}</td>
          <td>
            <button class="btn btn-sm btn-blue view" data-id="${inq.id}">View</button>
          </td>
        </tr>`;
                    tbody.insertAdjacentHTML("beforeend", row);
                });

                // Add click listeners to all "View" buttons
                document.querySelectorAll(".view").forEach(button => {
                    button.addEventListener("click", () => {
                        const leadId = button.getAttribute("data-id");
                        // Redirect to view-lead.html with lead ID
                        window.location.href = `view-lead.html?id=${leadId}`;
                    });
                });

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load inquiries.</td></tr>';
            }
        }

        // Run on page load
        document.addEventListener("DOMContentLoaded", displayInquiries);
    </script>


</body>

</html>